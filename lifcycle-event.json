{
  "id": "f85c975d-5e25-36f1-96f3-af2079a78f98",
  "title": "Lifecycle Events Workflow",
  "tasks": {
    "js_set_parameters": {
      "name": "js_set_parameters",
      "input": {
        "script": "import { execution } from \"@dynatrace-sdk/automation-utils\"\n\nexport default async function () {\n  const ex = await execution()\n  const eventContext = ex.event()\n  \n  // Properties can be at top level or nested in properties object\n  const version = eventContext[\"service.version\"] || eventContext.properties?.[\"service.version\"] || \"unknown\"\n  const deploymentName = eventContext[\"cicd.deployment.name\"] || eventContext.properties?.[\"cicd.deployment.name\"] || \"unknown\"\n\n  console.log(`Extracted version: ${version}, deploymentName: ${deploymentName}`)\n  console.log(`Event context keys: ${Object.keys(eventContext).join(\", \")}`)\n\n  return {\n    version: version,\n    deploymentName: deploymentName\n  }\n}\n"
      },
      "action": "dynatrace.automations:run-javascript",
      "position": {
        "x": 0,
        "y": 1
      },
      "description": "Set Workflow-wide defaults that can be used by any task",
      "predecessors": []
    },
    "js_validate_entity": {
      "name": "js_validate_entity",
      "input": {
        "script": "import { queryExecutionClient } from \"@dynatrace-sdk/client-query\"\nimport { execution } from \"@dynatrace-sdk/automation-utils\"\n\nexport default async function ({ execution_id }) {\n  const ex = await execution(execution_id)\n  const eventContext = ex.event()\n  const props = eventContext.properties || {}\n  const timeout = 10\n\n  console.log(`Query entities for fabrik namespaces`)\n\n  // Query workloads in the fabrik namespaces\n  const workloadQuery =\n    'fetch dt.entity.cloud_application_instance \\\n                | fields entity.name, id, namespaceName, runningContainersCount, desiredContainersCount, `dt.entity.cloud_application` = instance_of[`dt.entity.cloud_application`] \\\n                | filter in(namespaceName, \"fabrik-oa\", \"fabrik-ot\", \"fabrik-oa-2\") \\\n                | fieldsAdd ready = if(runningContainersCount == desiredContainersCount, true, else: false) \\\n                | filter ready \\\n                | fieldsAdd workload_id = dt.entity.cloud_application \\\n                | fieldsAdd workload_name = entityName(dt.entity.cloud_application) \\\n                | summarize {podCount = count(), podNames = collectDistinct(entity.name), podIds = collectDistinct(id)}, by: {namespaceName, workload_id, workload_name, ready}'\n\n  const workloadResponse = await queryExecutionClient.queryExecute({\n    body: {\n      query: workloadQuery,\n      requestTimeoutMilliseconds: timeout * 1000,\n      fetchTimeoutSeconds: timeout,\n    },\n  })\n\n  // Query services in the fabrik namespaces\n  const serviceQuery =\n    'fetch dt.entity.service \\\n                | fields entity.name, id, managementZones \\\n                | filter isNotNull(managementZones) \\\n                | expand managementZones \\\n                | filter in(managementZones, \"fabrik-oa\", \"fabrik-ot\", \"fabrik-oa-2\") \\\n                | fieldsAdd service_id = id \\\n                | fieldsAdd service_name = entity.name'\n\n  const serviceResponse = await queryExecutionClient.queryExecute({\n    body: {\n      query: serviceQuery,\n      requestTimeoutMilliseconds: timeout * 1000,\n      fetchTimeoutSeconds: timeout,\n    },\n  })\n\n  console.log(`Found ${workloadResponse.result.records?.length || 0} workloads`)\n  console.log(`Found ${serviceResponse.result.records?.length || 0} services`)\n  \n  // Log service IDs\n  if (serviceResponse.result.records) {\n    serviceResponse.result.records.forEach(service => {\n      console.log(`Service: ${service.service_name} ID: ${service.service_id}`)\n    })\n  }\n\n  if (workloadResponse.result.records == null || workloadResponse.result.records.length == 0) {\n    throw new Error(`No workload entities returned for fabrik namespaces`)\n  }\n\n  return {\n    workloads: workloadResponse.result.records,\n    services: serviceResponse.result.records || []\n  }\n}\n"
      },
      "retry": {
        "count": 10,
        "delay": 60,
        "failedLoopIterationsOnly": true
      },
      "action": "dynatrace.automations:run-javascript",
      "position": {
        "x": 0,
        "y": 2
      },
      "conditions": {
        "else": "STOP",
        "custom": "",
        "states": {
          "js_set_parameters": "SUCCESS"
        }
      },
      "description": "Query deployment entity and validate that it is observed with Dynatrace",
      "predecessors": [
        "js_set_parameters"
      ]
    },
    "send_deployment_events": {
      "name": "send_deployment_events",
      "input": {
        "script": "import { execution } from \"@dynatrace-sdk/automation-utils\"\nimport { eventsClient } from \"@dynatrace-sdk/client-classic-environment-v2\"\n\nconst PARAMETERS_TASK = \"js_set_parameters\"\nconst VALIDATE_TASK = \"js_validate_entity\"\n\nexport default async function () {\n  const ex = await execution()\n  const parameters = await ex.result(PARAMETERS_TASK)\n  const validateResults = await ex.result(VALIDATE_TASK)\n  const eventContext = ex.event()\n  const props = eventContext.properties || {}\n\n  const version = parameters[\"version\"]\n  const deploymentName = parameters[\"deploymentName\"]\n\n  const workloads = validateResults.workloads || []\n  const services = validateResults.services || []\n  \n  console.log(`Found ${workloads.length} workloads and ${services.length} services to correlate with deployment`)\n\n  // Send deployment correlation events to workloads\n  for (const entity of workloads) {\n      const workloadId = entity.workload_id\n      console.log(`Correlating deployment with workload: ${workloadId}`)\n      \n      const payload = {\n        eventType: \"CUSTOM_DEPLOYMENT\",\n        title: `Fabrik Deployment: ${deploymentName}`,\n        entitySelector: `entityId(\"${workloadId}\")`,\n        properties: {\n          source: \"fabrik-simulation\",\n          \"deployment.version\": version,\n          \"deployment.name\": deploymentName,\n          \"deployment.app\": \"fabrik\"\n        }\n      }\n      await sendDeploymentEvent(payload)\n  }\n\n  // Send deployment correlation events to services\n  for (const service of services) {\n      const serviceId = service.service_id\n      const serviceName = service.service_name\n      console.log(`Correlating deployment with service: ${serviceName} (ID: ${serviceId})`)\n      \n      const servicePayload = {\n        eventType: \"CUSTOM_DEPLOYMENT\",\n        title: `Fabrik Deployment: ${deploymentName}`,\n        entitySelector: `entityId(\"${serviceId}\")`,\n        properties: {\n          source: \"fabrik-simulation\",\n          \"deployment.version\": version,\n          \"deployment.name\": deploymentName,\n          \"deployment.app\": \"fabrik\",\n          \"service.name\": serviceName\n        }\n      }\n      await sendDeploymentEvent(servicePayload)\n  }\n\n  return { status: \"Deployment events correlated with entities\" }\n}\n\nasync function sendDeploymentEvent(body) {\n  try {\n      const sendEvent = await eventsClient.createEvent({ body })\n      console.log(`Deployment event sent successfully`)\n      return sendEvent\n  } catch (e) {\n      console.error(`Failed to send deployment event: ${e}`)\n  }\n}\n"
      },
      "action": "dynatrace.automations:run-javascript",
      "active": true,
      "position": {
        "x": 0,
        "y": 3
      },
      "conditions": {
        "states": {
          "js_validate_entity": "SUCCESS"
        }
      },
      "description": "Send deployment events to impacted entities",
      "predecessors": [
        "js_validate_entity"
      ]
    }
  },
  "description": "This workflow sends notifications back to ArgoCD Notifications Plugin when a new BizEvent is received from Argo",
  "isPrivate": false,
  "trigger": {
    "eventTrigger": {
      "isActive": true,
      "filterQuery": "event.type == \"CUSTOM_INFO\" and argocd.app.name == \"fabrik\" and matchesPhrase(title, \"ArgoCD Deployment\")",
      "uniqueExpression": null,
      "triggerConfiguration": {
        "type": "event",
        "value": {
          "query": "event.type == \"CUSTOM_INFO\" and argocd.app.name == \"fabrik\" and matchesPhrase(title, \"ArgoCD Deployment\")",
          "eventType": "events"
        }
      }
    }
  },
  "schemaVersion": 3,
  "result": null,
  "input": {},
  "hourlyExecutionLimit": 1000,
  "type": "STANDARD"
}
